# ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½åœæ­¢ è¦ä»¶å®šç¾©æ›¸

**Document Version:** 1.1
**ä½œæˆæ—¥:** 2025-12-05
**æœ€çµ‚æ›´æ–°:** 2025-12-05
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** Ready for Review
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œ:** å°‚é–€çš„ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜äº‹é …ã‚’å®Œå…¨åæ˜ 

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®å‰ææ¡ä»¶](#ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®å‰ææ¡ä»¶)
3. [èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼](#èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼)
4. [ç›®çš„ã¨ã‚¹ã‚³ãƒ¼ãƒ—](#ç›®çš„ã¨ã‚¹ã‚³ãƒ¼ãƒ—)
5. [ç¾çŠ¶åˆ†æ](#ç¾çŠ¶åˆ†æ)
6. [ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼å›³](#ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼å›³)
7. [è¦ä»¶å®šç¾©](#è¦ä»¶å®šç¾©)
8. [å®Ÿè£…è¨ˆç”»](#å®Ÿè£…è¨ˆç”»)
9. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#ãƒ†ã‚¹ãƒˆè¨ˆç”»)
10. [ãƒªã‚¹ã‚¯ã¨å¯¾ç­–](#ãƒªã‚¹ã‚¯ã¨å¯¾ç­–)
11. [ä»˜éŒ²](#ä»˜éŒ²)

---

## æ¦‚è¦

### èƒŒæ™¯

civicship-portalã«ãŠã‘ã‚‹ãƒã‚±ãƒƒãƒˆé–¢é€£æ©Ÿèƒ½ã‚’å…¨é¢çš„ã«åœæ­¢ã™ã‚‹ã€‚å¯¾è±¡ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¯ `neo88` ã¨ `default` ã®2ã¤ã€‚

### å½±éŸ¿ç¯„å›²

- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆå—ã‘å–ã‚Šã€ä¸€è¦§ã€ä½¿ç”¨ï¼‰
- ç®¡ç†è€…å‘ã‘ãƒã‚±ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½ï¼ˆç™ºè¡Œã€Utilityç®¡ç†ï¼‰
- äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆæ©Ÿèƒ½ï¼ˆãƒã‚±ãƒƒãƒˆæ”¯æ‰•ã„ï¼‰
- æ¤œç´¢æ©Ÿèƒ½ã®ãƒã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

### ãƒ“ã‚¸ãƒã‚¹ç›®æ¨™

- ä½¿ç”¨ã—ãªã„æ©Ÿèƒ½ã®éè¡¨ç¤ºã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æ˜ç¢ºåŒ–
- ä¸è¦ãªæ©Ÿèƒ½ã®ä¿å®ˆã‚³ã‚¹ãƒˆå‰Šæ¸›
- å°†æ¥ã®å†æœ‰åŠ¹åŒ–ã‚’å®¹æ˜“ã«ã™ã‚‹è¨­è¨ˆã®ç¶­æŒ

---

## ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®å‰ææ¡ä»¶

> **ğŸ’¡ ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼å‘ã‘**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½åœæ­¢ã®å®Ÿè£…ã«å¿…è¦ãªæŠ€è¡“çš„å‰æçŸ¥è­˜ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### 1. Next.js App Router ã®æ§‹æˆ

#### Server Component ã¨ Client Component

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **Next.js 13+ App Router** ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

**åŸºæœ¬åŸå‰‡:**
```typescript
// Server Component (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
// - ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹
// - ç’°å¢ƒå¤‰æ•°ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
// - useState, useEffect ãªã©ã®ãƒ•ãƒƒã‚¯ã¯ä½¿ç”¨ä¸å¯

export default function ServerPage() {
  const config = currentCommunityConfig; // âœ… ãƒ“ãƒ«ãƒ‰æ™‚ã«è©•ä¾¡
  return <div>{config.title}</div>;
}

// Client Component ("use client" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–)
// - ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã•ã‚Œã‚‹
// - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªæ©Ÿèƒ½ãŒå¿…è¦ãªå ´åˆã«ä½¿ç”¨
// - useState, useEffect ãªã©ã®ãƒ•ãƒƒã‚¯ãŒä½¿ç”¨å¯èƒ½

"use client";
export default function ClientPage() {
  const [count, setCount] = useState(0); // âœ… OK
  return <button onClick={() => setCount(count + 1)}>{count}</button>;
}
```

**æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é‡è¦ãªæ§‹æˆ:**

| ãƒšãƒ¼ã‚¸/ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ã‚¿ã‚¤ãƒ— | ç†ç”± |
|-------------------|--------|------|
| `/tickets/page.tsx` | Server | é™çš„ãªãƒã‚±ãƒƒãƒˆä¸€è¦§è¡¨ç¤º |
| `/tickets/receive/page.tsx` | Server | ãƒã‚±ãƒƒãƒˆå—ã‘å–ã‚Šãƒšãƒ¼ã‚¸ |
| `/admin/tickets/page.tsx` | Server | ç®¡ç†ç”»é¢ãƒã‚±ãƒƒãƒˆä¸€è¦§ |
| `/reservation/confirm/page.tsx` | **Client** | GraphQLã‚¯ã‚¨ãƒªã€çŠ¶æ…‹ç®¡ç†ãŒå¿…è¦ |
| `TicketsToggle.tsx` | Client | ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªUI |
| `SearchFilters.tsx` | Client | ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œãŒå¿…è¦ |

**âœ… é‡è¦ãªçµè«–:**
- **`/reservation/confirm` ã¯å…¨ä½“ãŒ Client Component** ã®ãŸã‚ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã®ã€ŒServer ã§ feature flags ã‚’é›†ç´„ã—ã¦ Client ã«æ¸¡ã™ã€ã¯ä¸è¦
- `currentCommunityConfig` ã‚’ Client Component ã§ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‚‚å•é¡Œãªã—ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«å€¤ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ãŸã‚ï¼‰

---

### 2. ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨­å®šã‚·ã‚¹ãƒ†ãƒ 

#### ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£åˆ¤å®š

**ä»•çµ„ã¿:**
```typescript
// /src/lib/communities/metadata.ts

// ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿å–ã‚Š
export function getCommunityIdFromEnv(): string {
  const communityId = process.env.NEXT_PUBLIC_COMMUNITY_ID;
  if (!communityId) return "default";
  return communityId;
}

// ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ“ãƒ«ãƒ‰æ™‚ã«è©•ä¾¡ã•ã‚Œã‚‹
export const COMMUNITY_ID = getCommunityIdFromEnv();

// ã‚¹ãƒ†ãƒƒãƒ—3: è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
export const currentCommunityConfig = COMMUNITY_BASE_CONFIG[COMMUNITY_ID];
```

**å‹•ä½œã‚¿ã‚¤ãƒŸãƒ³ã‚°:**
```
ãƒ“ãƒ«ãƒ‰æ™‚ (next build)
  â†“
process.env.NEXT_PUBLIC_COMMUNITY_ID ã‚’èª­ã¿å–ã‚Š
  â†“
COMMUNITY_ID ãŒ "neo88" ã¾ãŸã¯ "default" ã«å›ºå®šã•ã‚Œã‚‹
  â†“
ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã«å€¤ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹
  â†“
ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  (next start)
  â†“
å€¤ã¯å¤‰æ›´ã•ã‚Œãªã„ï¼ˆé™çš„ï¼‰
```

**âœ… é‡è¦ãªçµè«–:**
- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£IDã¯ **ãƒ“ãƒ«ãƒ‰æ™‚ã«å›ºå®š**
- URLã€Cookieã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚ˆã‚‹**å‹•çš„åˆ‡ã‚Šæ›¿ãˆã¯å­˜åœ¨ã—ãªã„**
- ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã®ã€Œå‹•çš„ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å¯¾å¿œã€ã®æ‡¸å¿µã¯**è©²å½“ã—ãªã„**

---

### 3. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã‚·ã‚¹ãƒ†ãƒ 

#### enableFeatures é…åˆ—ã®ä»•çµ„ã¿

**å®šç¾©:**
```typescript
type FeaturesType =
  | "places"
  | "opportunities"
  | "points"
  | "tickets"  // â† ä»Šå›å‰Šé™¤å¯¾è±¡
  | "articles"
  | "prefectures"
  | "credentials"
  | "justDaoIt"
  | "quests"
  | "languageSwitcher";

interface CommunityBaseConfig {
  id: string;
  enableFeatures: FeaturesType[]; // â† ã“ã“ã§åˆ¶å¾¡
  // ...
}
```

**ç¾åœ¨ã®è¨­å®š:**
```typescript
const COMMUNITY_BASE_CONFIG = {
  neo88: {
    enableFeatures: [
      "opportunities",
      "points",
      "articles",
      "tickets",      // â† æœ‰åŠ¹
      "prefectures",
      "quests"
    ],
  },
  default: {
    enableFeatures: [
      "opportunities",
      "places",
      "points",
      "articles",
      "tickets",      // â† æœ‰åŠ¹
      "prefectures",
      "quests"
    ],
  },
  "himeji-ymca": {
    enableFeatures: [
      "opportunities",
      "points",
      "articles",
      // "tickets" ãªã— â† ã™ã§ã«ç„¡åŠ¹
      "prefectures"
    ],
  },
};
```

**ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³:**
```typescript
// ãƒ‘ã‚¿ãƒ¼ãƒ³1: æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
{currentCommunityConfig.enableFeatures.includes("tickets") && (
  <TicketTab />
)}

// ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
  return null;
}

// ãƒ‘ã‚¿ãƒ¼ãƒ³3: 404ã‚¨ãƒ©ãƒ¼
if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
  notFound();
}
```

---

### 4. GraphQL ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### Apollo Client ã®ä½¿ç”¨

**ã‚¯ã‚¨ãƒªã®å®šç¾©:**
```typescript
// /src/graphql/account/wallet/query.ts
export const GET_WALLETS_WITH_TICKET = gql`
  query GetWalletsWithTicket($filter: WalletFilterInput, ...) {
    wallets(filter: $filter, ...) {
      edges {
        node {
          ...WalletFields
          tickets {              # â† ãƒã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            ...TicketFields
            utility {
              ...UtilityFields
            }
          }
        }
      }
    }
  }
`;
```

**ä½¿ç”¨ç®‡æ‰€:**
```typescript
// /src/app/reservation/confirm/hooks/useWalletData.ts
export function useWalletData(userId?: string) {
  const { data, loading } = useGetWalletsWithTicketQuery({
    variables: { filter: { userId, ... } },
  });

  const tickets: GqlTicket[] = useMemo(
    () => wallets?.[0]?.tickets ?? [],
    [wallets]
  );

  return { tickets, ... };
}
```

**âœ… é‡è¦ãªçµè«–:**
- ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‚‚ã€**GraphQL ã‚¯ã‚¨ãƒªã¯ tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—ã—ç¶šã‘ã‚‹**
- API å´ã¯å‰Šé™¤ã—ãªã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã¯å‡ºãªã„
- ãŸã ã—ã€**ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç™ºç”Ÿ**
- å†æœ‰åŠ¹åŒ–ã‚’æƒ³å®šã™ã‚‹ãªã‚‰ã€ã‚¯ã‚¨ãƒªã¯ãã®ã¾ã¾æ®‹ã™ã®ãŒæ¨å¥¨

---

### 5. äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹æˆ

#### æ”¯æ‰•ã„æ–¹æ³•ã®ç¨®é¡

äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã¯ **3ã¤ã®æ”¯æ‰•ã„æ–¹æ³•** ã‚’ã‚µãƒãƒ¼ãƒˆ:

```typescript
enum PaymentMethod {
  CASH = "ç¾é‡‘",
  POINTS = "ãƒã‚¤ãƒ³ãƒˆ",
  TICKET = "ãƒã‚±ãƒƒãƒˆ"  // â† ä»Šå›ç„¡åŠ¹åŒ–å¯¾è±¡
}
```

**äºˆç´„ãƒ•ãƒ­ãƒ¼:**
```
1. Opportunity (ä½“é¨“) ã‚’é¸æŠ
   â†“
2. Slot (æ—¥æ™‚) ã‚’é¸æŠ
   â†“
3. äºˆç´„ç¢ºèªç”»é¢ (/reservation/confirm)
   â†“
4. æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ
   - ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨ (usePoints: boolean)
   - ãƒã‚±ãƒƒãƒˆåˆ©ç”¨ (useTickets: boolean)
   â†“
5. äºˆç´„ä½œæˆ (createReservation mutation)
   - paymentMethod: "TICKET"
   - ticketIdsIfNeed: string[]
```

**maxTickets ã®è¨ˆç®—:**
```typescript
// /src/app/reservation/confirm/utils/reservationCalculations.ts
const availableTicketCount = wallet?.tickets.filter(
  ticket => ticket.utility?.requiredForOpportunityIds?.includes(opportunityId)
).length ?? 0;

const maxTickets = Math.min(availableTicketCount, participantCount);
```

**æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°:**
```typescript
// /src/app/reservation/confirm/components/payment/PaymentSection.tsx
{maxTickets > 0 && (
  <TicketsToggle ... />  // â† maxTickets = 0 ãªã‚‰éè¡¨ç¤º
)}
```

**âœ… é‡è¦ãªçµè«–:**
- ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã¨ã€`maxTickets = 0` ã«ãªã‚‹
- æ—¢å­˜ã®æ¡ä»¶åˆ†å²ã«ã‚ˆã‚Šã€**è‡ªå‹•çš„ã« TicketsToggle ãŒéè¡¨ç¤º**
- ãŸã ã—ã€GraphQL ã‚¯ã‚¨ãƒªã¯å¼•ãç¶šã tickets ã‚’å–å¾—

---

### 6. æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹æˆ

#### URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

**ãƒ•ãƒ­ãƒ¼ãƒã‚§ãƒ¼ãƒ³:**
```
1. SearchFilters.tsx
   â†“ useTicket: boolean
2. useSearchForm hook
   â†“ ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
3. buildSearchResultParams()
   â†“ useTicket â†’ ticket=1
4. URL: /search/result?ticket=1
   â†“
5. result/page.tsx
   â†“ searchParams.get("ticket")
6. useSearchResults hook
   â†“ filter.isReservableWithTicket = true
7. GraphQL ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
```

**å®Ÿè£…è©³ç´°:**
```typescript
// /src/app/search/data/presenter.ts
export function buildSearchResultParams(
  q: string,
  location: string,
  dateRange: DateRange | undefined,
  guests: number,
  useTicket: boolean,  // â† ã“ã“ã‹ã‚‰
  usePoints: boolean,
  type: "activity" | "quest",
): URLSearchParams {
  const params = new URLSearchParams();
  if (useTicket) params.set("ticket", "1");  // â† ã“ã“ã¸
  // ...
}

// /src/app/search/result/hooks/useSearchResults.ts
if (searchParams.ticket === "1") {
  filter.isReservableWithTicket = true;  // â† GraphQL ãƒ•ã‚£ãƒ«ã‚¿
}
```

**âœ… é‡è¦ãªçµè«–:**
- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ **è¤‡æ•°ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼** ã§é€£æº
- ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ç„¡åŠ¹åŒ–ã«ã¯ã€**SearchFilters.tsx ã§ã®æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°** ãŒå¿…è¦
- URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `ticket=1` ãŒæ¸¡ã•ã‚Œã¦ã‚‚ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIãŒéè¡¨ç¤ºãªã‚‰å•é¡Œãªã—

---

## èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼

### ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹èª¿æŸ»ã§åˆ¤æ˜ã—ãŸäº‹å®Ÿ

| é …ç›® | èª¿æŸ»çµæœ | å½±éŸ¿ |
|------|---------|------|
| **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£åˆ¤å®š** | ç’°å¢ƒå¤‰æ•° `NEXT_PUBLIC_COMMUNITY_ID` ã§é™çš„æ±ºå®š | å‹•çš„åˆ‡ã‚Šæ›¿ãˆã®æ‡¸å¿µã¯ä¸è¦ |
| **currentCommunityConfig** | ãƒ“ãƒ«ãƒ‰æ™‚ã«å›ºå®šã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¤‰æ›´ãªã— | Server/Client ã®åŒºåˆ¥ã¯ä¸è¦ |
| **GraphQL ã‚¯ã‚¨ãƒª** | `GET_WALLETS_WITH_TICKET` ã§ tickets å–å¾— | ç„¡åŠ¹åŒ–å¾Œã‚‚å–å¾—ã—ç¶šã‘ã‚‹ |
| **äºˆç´„ç”»é¢æ§‹æˆ** | å…¨ä½“ãŒ Client Component | Server ã§ã® props æ¸¡ã—ä¸è¦ |
| **æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼** | 5ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§é€£æº | SearchFilters.tsx ã§åˆ¶å¾¡ |

### ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã¸ã®å¯¾å¿œ

#### âœ… æŒ‡æ‘˜1: currentCommunityConfig ã®å‹•çš„æ€§

**æŒ‡æ‘˜å†…å®¹:**
> ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£é¸æŠãŒ URL/Cookie/ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚ˆã‚‹åˆ‡ã‚Šæ›¿ãˆãªã‚‰ã€Server Component ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã® Context ã‚’èª­ã‚€å¿…è¦ãŒã‚ã‚‹

**èª¿æŸ»çµæœ:**
- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£IDã¯ç’°å¢ƒå¤‰æ•° `NEXT_PUBLIC_COMMUNITY_ID` ã§æ±ºå®š
- ãƒ“ãƒ«ãƒ‰æ™‚ã«å›ºå®šã•ã‚Œã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¤‰æ›´ãªã—

**çµè«–:** âœ… ã“ã®æ‡¸å¿µã¯è©²å½“ã—ãªã„

---

#### âœ… æŒ‡æ‘˜2: Client Component ã§ã® feature flag ã®æ‰±ã„

**æŒ‡æ‘˜å†…å®¹:**
> `currentCommunityConfig` ã‚’ç›´æ¥ import ã™ã‚‹ã¨ã€ãƒ“ãƒ«ãƒ‰æ™‚ã®å€¤ãŒå›ºå®šã•ã‚Œã‚‹å¯èƒ½æ€§

**èª¿æŸ»çµæœ:**
- `/reservation/confirm/page.tsx` ã¯å…¨ä½“ãŒ Client Component
- `NEXT_PUBLIC_` ç’°å¢ƒå¤‰æ•°ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ï¼ˆæ„å›³ã•ã‚ŒãŸå‹•ä½œï¼‰

**çµè«–:** âœ… ç›´æ¥ import ã—ã¦ã‚‚å•é¡Œãªã—

---

#### âœ… æŒ‡æ‘˜3: GraphQL ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€é©åŒ–

**æŒ‡æ‘˜å†…å®¹:**
> äºˆç´„ç¢ºèªã® GraphQL å–å¾—ã§ Ticket ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—ã—ã¦ã„ã‚‹å¯èƒ½æ€§

**èª¿æŸ»çµæœ:**
- `GET_WALLETS_WITH_TICKET` ã§ `tickets { ...TicketFields }` ã‚’å–å¾—
- ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ç„¡åŠ¹åŒ–å¾Œã‚‚å–å¾—ã—ç¶šã‘ã‚‹

**å¯¾å¿œæ–¹é‡:**
- **å†æœ‰åŠ¹åŒ–ã‚’æƒ³å®šã™ã‚‹ãŸã‚ã€ã‚¯ã‚¨ãƒªã¯å¤‰æ›´ã—ãªã„**
- UI éè¡¨ç¤ºã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã¯ä½¿ç”¨ã•ã‚Œãªã„
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿ã¯è»½å¾®ï¼ˆtickets ã¯é€šå¸¸0-10ä»¶ç¨‹åº¦ï¼‰

**çµè«–:** âœ… ã‚¯ã‚¨ãƒªã¯ç¾çŠ¶ç¶­æŒï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ˜è¨˜ï¼‰

---

#### âœ… æŒ‡æ‘˜4: æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å®Ÿè£…ç®‡æ‰€

**æŒ‡æ‘˜å†…å®¹:**
> "è©²å½“ç®‡æ‰€èª¿æŸ»" ãŒæœªå®Œäº†ã€‚å¾Œå›ã—ã«ã™ã‚‹ã¨ãƒã‚°ã«ã¤ãªãŒã‚‹

**èª¿æŸ»çµæœ:**
- ä¿®æ­£ç®‡æ‰€: `SearchFilters.tsx` (94-115è¡Œç›®)
- æ¡ä»¶: `currentCommunityConfig.enableFeatures.includes("tickets")`

**å¯¾å¿œæ–¹é‡:**
- Phase 3 ã§ `SearchFilters.tsx` ã‚’ä¿®æ­£
- æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ "ãã®ä»–ã®æ¡ä»¶" ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’åˆ¶å¾¡

**çµè«–:** âœ… å®Ÿè£…ç®‡æ‰€ã‚’ç‰¹å®šæ¸ˆã¿

---

## ç›®çš„ã¨ã‚¹ã‚³ãƒ¼ãƒ—

### ä¸»ç›®çš„

ãƒã‚±ãƒƒãƒˆé–¢é€£æ©Ÿèƒ½ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ç®¡ç†è€…ã¨ã‚‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«ã™ã‚‹

### å‰¯æ¬¡çš„ç›®çš„

- ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ç°¡ç´ åŒ–
- ä¸è¦ãªæ©Ÿèƒ½ã®ä¿å®ˆã‚³ã‚¹ãƒˆå‰Šæ¸›
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æ˜ç¢ºåŒ–ï¼ˆä½¿ç”¨ã—ãªã„æ©Ÿèƒ½ã®éè¡¨ç¤ºï¼‰

### éç›®çš„

- ãƒã‚±ãƒƒãƒˆé–¢é€£ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆå°†æ¥ã®å†æœ‰åŠ¹åŒ–ã®å¯èƒ½æ€§ã‚’æ®‹ã™ï¼‰
- GraphQL APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‰Šé™¤
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´
- GraphQL ã‚¯ã‚¨ãƒªã‹ã‚‰ã® tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤ï¼ˆå†æœ‰åŠ¹åŒ–ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ï¼‰

### ã‚¹ã‚³ãƒ¼ãƒ—

#### å®Ÿè£…å¯¾è±¡ (In Scope)

**Phase 1: ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã®ç„¡åŠ¹åŒ–**
- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨­å®šã‹ã‚‰ã® `"tickets"` ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼å‰Šé™¤
- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã®è‡ªå‹•éè¡¨ç¤º

**Phase 2: ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒã‚±ãƒƒãƒˆãƒšãƒ¼ã‚¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆ404ï¼‰
- ç®¡ç†ç”»é¢ãƒã‚±ãƒƒãƒˆãƒšãƒ¼ã‚¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆ404ï¼‰

**Phase 3: çµ±åˆæ©Ÿèƒ½ã®ç„¡åŠ¹åŒ–**
- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰ã®ãƒã‚±ãƒƒãƒˆé–¢é€£é …ç›®å‰Šé™¤

#### å®Ÿè£…å¯¾è±¡å¤– (Out of Scope)

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤
- GraphQL APIã®å‰Šé™¤
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã®å‰Šé™¤
- GraphQL ã‚¯ã‚¨ãƒªã® tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤
- ä»–ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼ˆæ—¢ã«ç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰ã®è¨­å®šå¤‰æ›´
- äºˆç´„ç¢ºèªç”»é¢ã® TicketsToggle ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¿®æ­£ï¼ˆmaxTickets=0 ã§è‡ªå‹•éè¡¨ç¤ºï¼‰

---

## ç¾çŠ¶åˆ†æ

### ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ã®æ§‹æˆè¦ç´ 

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

```mermaid
erDiagram
    Ticket ||--o{ TicketClaimLink : "ç™ºè¡Œã•ã‚Œã‚‹"
    Ticket }o--|| Utility : "ç¨®é¡"
    Ticket }o--|| TicketIssuer : "ç™ºè¡Œè€…"
    Utility }o--o{ Opportunity : "åˆ©ç”¨å¯èƒ½ãªä½“é¨“"

    Ticket {
        string id
        string status
        int count
    }

    TicketClaimLink {
        string id
        string status
        int qty
        datetime claimedAt
    }

    Utility {
        string id
        string name
        int pointsRequired
    }

    TicketIssuer {
        string id
        string ownerId
    }
```

#### ãƒšãƒ¼ã‚¸æ§‹æˆ

**ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘:**
- `/tickets` - ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸
- `/tickets/receive` - ãƒã‚±ãƒƒãƒˆå—ã‘å–ã‚Šãƒšãƒ¼ã‚¸

**ç®¡ç†è€…å‘ã‘:**
- `/admin/tickets` - ãƒã‚±ãƒƒãƒˆç®¡ç†ãƒšãƒ¼ã‚¸
- `/admin/tickets/[id]` - ãƒã‚±ãƒƒãƒˆè©³ç´°ãƒšãƒ¼ã‚¸
- `/admin/tickets/utilities` - Utilityç®¡ç†ãƒšãƒ¼ã‚¸

#### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ãƒ‘ã‚¹ | ã‚¿ã‚¤ãƒ— | ç”¨é€” |
|--------------|------|--------|------|
| `TicketList` | `/src/app/tickets/components/TicketList.tsx` | Client | ãƒã‚±ãƒƒãƒˆä¸€è¦§è¡¨ç¤º |
| `TicketReceiveContent` | `/src/app/tickets/receive/components/TicketReceiveContent.tsx` | Client | ãƒã‚±ãƒƒãƒˆå—ã‘å–ã‚ŠUI |
| `CreateTicketSheet` | `/src/app/admin/tickets/components/CreateTicketSheet.tsx` | Client | ãƒã‚±ãƒƒãƒˆç™ºè¡ŒUI |
| `TicketsToggle` | `/src/app/reservation/confirm/components/payment/TicketsToggle.tsx` | Client | äºˆç´„æ™‚ã®ãƒã‚±ãƒƒãƒˆé¸æŠ |
| `UserTicketsAndPoints` | `/src/app/users/features/profile/components/UserTicketsAndPoints.tsx` | Client | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒã‚±ãƒƒãƒˆè¡¨ç¤º |
| `SearchFilters` | `/src/app/search/components/SearchFilters.tsx` | Client | æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ |

#### ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°åˆ¶å¾¡ç®‡æ‰€

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œç•ªå· | åˆ¶å¾¡å†…å®¹ | å‹•ä½œ |
|---------|--------|---------|------|
| `AdminBottomBar.tsx` | 53-60 | ç®¡ç†ç”»é¢ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– | âœ… è‡ªå‹•éè¡¨ç¤º |
| `UserTicketsAndPoints.tsx` | 61-65 | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®ãƒã‚±ãƒƒãƒˆè¡¨ç¤º | âœ… è‡ªå‹•éè¡¨ç¤º |
| `admin/page.tsx` | 37-42, 76-80 | ç®¡ç†è¨­å®šãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ | âœ… è‡ªå‹•éè¡¨ç¤º |

#### GraphQL API

**ã‚¯ã‚¨ãƒª:**
- `GET_TICKETS` - ãƒã‚±ãƒƒãƒˆä¸€è¦§å–å¾—
- `VIEW_TICKET_CLAIM_LINKS` - ãƒã‚±ãƒƒãƒˆã‚¯ãƒ¬ãƒ¼ãƒ ãƒªãƒ³ã‚¯å–å¾—
- `GET_TICKET_ISSUERS` - ç™ºè¡Œè€…æƒ…å ±å–å¾—
- `GET_UTILITIES` - Utilityä¸€è¦§å–å¾—
- `GET_WALLETS_WITH_TICKET` - ã‚¦ã‚©ãƒ¬ãƒƒãƒˆï¼‹ãƒã‚±ãƒƒãƒˆå–å¾—ï¼ˆäºˆç´„ç¢ºèªç”»é¢ã§ä½¿ç”¨ï¼‰

**ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³:**
- `TICKET_ISSUE` - ãƒã‚±ãƒƒãƒˆç™ºè¡Œ
- `TICKET_CLAIM` - ãƒã‚±ãƒƒãƒˆå—ã‘å–ã‚Š
- `CREATE_UTILITY` - Utilityä½œæˆ
- `createReservation` (ãƒã‚±ãƒƒãƒˆä½¿ç”¨å«ã‚€) - äºˆç´„ä½œæˆ

---

## ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼å›³

### ãƒã‚±ãƒƒãƒˆç™ºè¡Œãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†è€…
    participant AdminUI as /admin/tickets
    participant CreateSheet as CreateTicketSheet
    participant GQL as GraphQL API
    participant DB as Database

    Admin->>AdminUI: ãƒã‚±ãƒƒãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ã
    AdminUI->>Admin: ç™ºè¡Œæ¸ˆã¿ãƒªã‚¹ãƒˆè¡¨ç¤º
    Admin->>CreateSheet: ã€Œæ–°è¦ç™ºè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    CreateSheet->>Admin: Utilityé¸æŠUIè¡¨ç¤º
    Admin->>CreateSheet: Utilityé¸æŠ + æšæ•°å…¥åŠ›
    CreateSheet->>GQL: TICKET_ISSUE mutation
    GQL->>DB: TicketClaimLinkä½œæˆ
    DB-->>GQL: ä½œæˆå®Œäº†
    GQL-->>CreateSheet: claimLinkIdè¿”å´
    CreateSheet->>Admin: QRã‚³ãƒ¼ãƒ‰ï¼‹ãƒªãƒ³ã‚¯è¡¨ç¤º
    Admin->>Admin: QRã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰
```

### ãƒã‚±ãƒƒãƒˆå—ã‘å–ã‚Šãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant ReceivePage as /tickets/receive
    participant GQL as GraphQL API
    participant DB as Database
    participant TicketsPage as /tickets

    User->>ReceivePage: QRã‚³ãƒ¼ãƒ‰/ãƒªãƒ³ã‚¯ã§ã‚¢ã‚¯ã‚»ã‚¹<br/>?token={claimLinkId}
    ReceivePage->>GQL: VIEW_TICKET_CLAIM query
    GQL->>DB: claimLinkå–å¾—
    DB-->>GQL: claimLinkæƒ…å ±
    GQL-->>ReceivePage: ãƒã‚±ãƒƒãƒˆè©³ç´°è¡¨ç¤º
    ReceivePage->>User: å—ã‘å–ã‚Šãƒœã‚¿ãƒ³è¡¨ç¤º
    User->>ReceivePage: ã€Œå—ã‘å–ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    ReceivePage->>GQL: TICKET_CLAIM mutation
    GQL->>DB: Ticketä½œæˆ<br/>claimLink.status = CLAIMED
    DB-->>GQL: å®Œäº†
    GQL-->>ReceivePage: æˆåŠŸ
    ReceivePage->>TicketsPage: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    TicketsPage->>User: ãƒã‚±ãƒƒãƒˆä¸€è¦§è¡¨ç¤º
```

### ãƒã‚±ãƒƒãƒˆä½¿ç”¨ãƒ•ãƒ­ãƒ¼ï¼ˆäºˆç´„æ™‚ãƒ»ç¾çŠ¶ï¼‰

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant ConfirmPage as /reservation/confirm
    participant WalletHook as useWalletData
    participant GQL as GraphQL API
    participant TicketsToggle as TicketsToggle UI

    User->>ConfirmPage: äºˆç´„ç¢ºèªç”»é¢ã‚’é–‹ã
    ConfirmPage->>WalletHook: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆå–å¾—
    WalletHook->>GQL: GET_WALLETS_WITH_TICKET query
    GQL-->>WalletHook: wallet { tickets { ... } }
    WalletHook-->>ConfirmPage: ticketsé…åˆ—è¿”å´

    alt maxTickets > 0
        ConfirmPage->>TicketsToggle: ãƒã‚±ãƒƒãƒˆé¸æŠUIè¡¨ç¤º
        TicketsToggle->>User: ãƒã‚±ãƒƒãƒˆé¸æŠå¯èƒ½
        User->>TicketsToggle: ãƒã‚±ãƒƒãƒˆã‚’é¸æŠ
    else maxTickets = 0
        ConfirmPage->>User: TicketsToggleéè¡¨ç¤º
    end

    User->>ConfirmPage: ã€Œç”³ã—è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    ConfirmPage->>GQL: createReservation mutation<br/>paymentMethod: "TICKET"<br/>ticketIdsIfNeed: [...]
    GQL-->>ConfirmPage: äºˆç´„å®Œäº†
    ConfirmPage->>User: å®Œäº†ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```

### ç„¡åŠ¹åŒ–å¾Œã®ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Browser as ãƒ–ãƒ©ã‚¦ã‚¶
    participant TicketsPage as /tickets/page.tsx
    participant Config as currentCommunityConfig
    participant NotFound as 404ãƒšãƒ¼ã‚¸

    User->>Browser: /tickets ã«ã‚¢ã‚¯ã‚»ã‚¹
    Browser->>TicketsPage: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰
    TicketsPage->>Config: enableFeatures.includes("tickets")?
    Config-->>TicketsPage: false
    TicketsPage->>NotFound: notFound() å®Ÿè¡Œ
    NotFound->>Browser: 404 Not Found
    Browser->>User: 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸è¡¨ç¤º
```

### ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•] --> B[ãƒ“ãƒ«ãƒ‰æ™‚]
    B --> C[NEXT_PUBLIC_COMMUNITY_ID èª­ã¿å–ã‚Š]
    C --> D{ç’°å¢ƒå¤‰æ•°ã®å€¤ã¯?}
    D -->|neo88| E[COMMUNITY_ID = 'neo88']
    D -->|default| F[COMMUNITY_ID = 'default']
    D -->|æœªè¨­å®š| G[COMMUNITY_ID = 'default']

    E --> H[currentCommunityConfig ç”Ÿæˆ]
    F --> H
    G --> H

    H --> I[enableFeatures é…åˆ—å–å¾—]
    I --> J{tickets ãŒå«ã¾ã‚Œã‚‹?}

    J -->|Yes| K[ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½æœ‰åŠ¹]
    J -->|No| L[ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ç„¡åŠ¹]

    K --> M[ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º]
    K --> N[ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½]
    K --> O[æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º]

    L --> P[ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³éè¡¨ç¤º]
    L --> Q[ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹404]
    L --> R[æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼éè¡¨ç¤º]
```

### æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```mermaid
graph LR
    A[SearchFilters UI] -->|useTicket: boolean| B[useSearchForm hook]
    B -->|ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹| C[buildSearchResultParams]
    C -->|ticket=1| D[URL Parameters]
    D -->|/search/result?ticket=1| E[result/page.tsx]
    E -->|searchParams.ticket| F[useSearchResults hook]
    F -->|isReservableWithTicket: true| G[GraphQL Query]
    G -->|filteré©ç”¨| H[Opportunitieså–å¾—]
    H -->|ãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯èƒ½ãªä½“é¨“ã®ã¿| I[æ¤œç´¢çµæœè¡¨ç¤º]
```

---

## è¦ä»¶å®šç¾©

### æ©Ÿèƒ½è¦ä»¶

#### FR-1: ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ç„¡åŠ¹åŒ–

**è¦ä»¶:**
å¯¾è±¡ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼ˆ`neo88`, `default`ï¼‰ã®è¨­å®šã‹ã‚‰ `"tickets"` ã‚’å‰Šé™¤ã™ã‚‹

**æŠ€è¡“è©³ç´°:**
```typescript
// /src/lib/communities/metadata.ts
const COMMUNITY_BASE_CONFIG: Record<string, CommunityBaseConfig> = {
  neo88: {
    enableFeatures: [
      "opportunities",
      "points",
      "articles",
      // "tickets", // â† å‰Šé™¤
      "prefectures",
      "quests"
    ],
  },
  default: {
    enableFeatures: [
      "opportunities",
      "places",
      "points",
      "articles",
      // "tickets", // â† å‰Šé™¤
      "prefectures",
      "quests"
    ],
  },
};
```

**å—å…¥åŸºæº–:**
- [ ] `/src/lib/communities/metadata.ts` ã® `neo88.enableFeatures` ã‹ã‚‰ `"tickets"` ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] `/src/lib/communities/metadata.ts` ã® `default.enableFeatures` ã‹ã‚‰ `"tickets"` ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] ç®¡ç†ç”»é¢ãƒœãƒˆãƒ ãƒãƒ¼ã«ãƒã‚±ãƒƒãƒˆã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œãªã„
- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œãªã„
- [ ] ç®¡ç†è¨­å®šãƒšãƒ¼ã‚¸ã«ãƒã‚±ãƒƒãƒˆç®¡ç†ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œãªã„

**è‡ªå‹•çš„ã«éè¡¨ç¤ºã«ãªã‚‹ç®‡æ‰€:**
- `AdminBottomBar.tsx` (L53-60) - ç®¡ç†ç”»é¢ã‚¿ãƒ–
- `UserTicketsAndPoints.tsx` (L61-65) - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
- `admin/page.tsx` (L37-42, L76-80) - è¨­å®šãƒªãƒ³ã‚¯

---

#### FR-2: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒšãƒ¼ã‚¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**è¦ä»¶:**
ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹ãªå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒã‚±ãƒƒãƒˆãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’404ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹

**å¯¾è±¡ãƒšãƒ¼ã‚¸:**
- `/tickets/page.tsx` - ãƒã‚±ãƒƒãƒˆä¸€è¦§
- `/tickets/receive/page.tsx` - ãƒã‚±ãƒƒãƒˆå—ã‘å–ã‚Š

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³:**
```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function TicketsPage() {
  // ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound(); // 404ã‚¨ãƒ©ãƒ¼
  }

  // æ—¢å­˜ã®å®Ÿè£…...
  return <TicketList />;
}
```

**å—å…¥åŸºæº–:**
- [ ] `/tickets` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨404ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `/tickets/receive?token=xxx` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨404ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãŒæœ‰åŠ¹ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼ˆä»–ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼‰ã§ã¯å¼•ãç¶šãã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚„å¤ã„ãƒªãƒ³ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚‚404ã«ãªã‚‹

---

#### FR-3: ç®¡ç†ç”»é¢ãƒšãƒ¼ã‚¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**è¦ä»¶:**
ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹ãªå ´åˆã€ç®¡ç†ç”»é¢ãƒã‚±ãƒƒãƒˆãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’404ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹

**å¯¾è±¡ãƒšãƒ¼ã‚¸:**
- `/admin/tickets/page.tsx` - ãƒã‚±ãƒƒãƒˆç®¡ç†ä¸€è¦§
- `/admin/tickets/[id]/page.tsx` - ãƒã‚±ãƒƒãƒˆè©³ç´°
- `/admin/tickets/utilities/page.tsx` - Utilityç®¡ç†

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³:**
```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function AdminTicketsPage() {
  // ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound();
  }

  // æ—¢å­˜ã®å®Ÿè£…...
  return <AdminTicketList />;
}
```

**å—å…¥åŸºæº–:**
- [ ] `/admin/tickets` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨404ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `/admin/tickets/123` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨404ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] `/admin/tickets/utilities` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨404ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãŒæœ‰åŠ¹ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã¯å¼•ãç¶šãã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

---

#### FR-4: æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰ã®ãƒã‚±ãƒƒãƒˆé …ç›®å‰Šé™¤

**è¦ä»¶:**
ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹ãªå ´åˆã€æ¤œç´¢ç”»é¢ã§ã€Œãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:**
- `/src/app/search/components/SearchFilters.tsx`

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³:**
```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";

const SearchFilters: React.FC<SearchFiltersProps> = ({ ... }) => {
  const { control } = useFormContext();
  const isTicketsEnabled = currentCommunityConfig.enableFeatures.includes("tickets");

  return (
    <div className="bg-background rounded-xl overflow-hidden">
      {/* å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <FormField ... />

      {/* æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <FormField ... />

      {/* äººæ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <FormField ... />

      {/* ãã®ä»–ã®æ¡ä»¶ï¼ˆãƒã‚±ãƒƒãƒˆãƒ»ãƒã‚¤ãƒ³ãƒˆï¼‰ */}
      {(isTicketsEnabled || usePoints) && (
        <FormField
          control={control}
          name="useTicket"
          render={() => (
            <FormControl>
              <FilterButton
                icon={<Tags className="h-4 w-4" />}
                label="ãã®ä»–ã®æ¡ä»¶"
                value=""
                active={useTicket}
                onClick={() => onFilterClick("other")}
                verticalLayout={true}
                className="rounded-b-xl"
              >
                {[
                  isTicketsEnabled && useTicket && "ãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯",
                  usePoints && "ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨å¯"
                ]
                  .filter(Boolean)
                  .join(",")}
              </FilterButton>
            </FormControl>
          )}
        />
      )}
    </div>
  );
};
```

**å—å…¥åŸºæº–:**
- [ ] æ¤œç´¢ç”»é¢ã§ã€Œãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„
- [ ] URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `?ticket=1` ãŒä»˜ã„ã¦ã„ã¦ã‚‚ã€UIä¸Šã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ãªã„
- [ ] ãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯å¼•ãç¶šãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ä»–ã®æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå ´æ‰€ã€æ—¥ä»˜ã€äººæ•°ï¼‰ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

#### FR-5: äºˆç´„ç¢ºèªç”»é¢ã§ã®è‡ªå‹•éè¡¨ç¤ºï¼ˆç¢ºèªäº‹é …ï¼‰

**è¦ä»¶:**
ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹ãªå ´åˆã€äºˆç´„ç¢ºèªç”»é¢ã§ãƒã‚±ãƒƒãƒˆé¸æŠUIãŒè‡ªå‹•çš„ã«éè¡¨ç¤ºã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

**ç¾çŠ¶ã®å®Ÿè£…:**
```typescript
// /src/app/reservation/confirm/components/payment/PaymentSection.tsx (L101-114)
{maxTickets > 0 && (
  <TicketsToggle
    useTickets={useTickets}
    setUseTickets={setUseTickets}
    maxTickets={maxTickets}
    availableTickets={availableTickets}
    // ...
  />
)}
```

**å‹•ä½œ:**
- `maxTickets` ã¯åˆ©ç”¨å¯èƒ½ãªãƒã‚±ãƒƒãƒˆæšæ•°
- ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ç„¡åŠ¹åŒ–å¾Œã¯ `maxTickets = 0` ã«ãªã‚‹
- æ¡ä»¶ `maxTickets > 0` ãŒ false ã¨ãªã‚Šã€TicketsToggle ã¯è‡ªå‹•çš„ã«éè¡¨ç¤º

**å—å…¥åŸºæº–:**
- [ ] äºˆç´„ç¢ºèªç”»é¢ã§ãƒã‚±ãƒƒãƒˆé¸æŠUIãŒè¡¨ç¤ºã•ã‚Œãªã„
- [ ] æ”¯æ‰•ã„æ–¹æ³•ã¨ã—ã¦ã€Œãƒã‚±ãƒƒãƒˆã€ãŒé¸æŠã§ããªã„
- [ ] æ—¢å­˜ã®ä»–ã®æ”¯æ‰•ã„æ–¹æ³•ï¼ˆãƒã‚¤ãƒ³ãƒˆã€ç¾é‡‘ï¼‰ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] **è¿½åŠ ã®å®Ÿè£…ã¯ä¸è¦**ï¼ˆæ—¢å­˜ã®æ¡ä»¶åˆ†å²ã§å¯¾å¿œæ¸ˆã¿ï¼‰

---

### éæ©Ÿèƒ½è¦ä»¶

#### NFR-1: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**è¦ä»¶:**
- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“ã¸ã®å½±éŸ¿: ãªã—
- ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰: 1msä»¥ä¸‹ï¼ˆãƒ¡ãƒ¢ãƒªå‚ç…§ã®ã¿ï¼‰

**æ ¹æ‹ :**
- `currentCommunityConfig` ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«è©•ä¾¡ã•ã‚Œã‚‹å®šæ•°
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã®è¨ˆç®—ã¯ç™ºç”Ÿã—ãªã„

---

#### NFR-2: äº’æ›æ€§

**è¦ä»¶:**
- æ—¢å­˜ã®ä»–ã®æ©Ÿèƒ½ï¼ˆãƒã‚¤ãƒ³ãƒˆã€äºˆç´„ç­‰ï¼‰ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒ
- ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãŒæœ‰åŠ¹ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã¯å¼•ãç¶šãå‹•ä½œ
- ä»–ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼ˆhimeji-ymca, kibotchaç­‰ï¼‰ã¸ã®å½±éŸ¿ãªã—

**ç¢ºèªé …ç›®:**
- [ ] ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] äºˆç´„æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] æ¤œç´¢æ©Ÿèƒ½ï¼ˆãƒã‚±ãƒƒãƒˆä»¥å¤–ï¼‰ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

#### NFR-3: ä¿å®ˆæ€§

**è¦ä»¶:**
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚’ç¶­æŒ
- å°†æ¥ã®å†æœ‰åŠ¹åŒ–ã‚’å®¹æ˜“ã«ã™ã‚‹è¨­è¨ˆ
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒ
- GraphQL ã‚¯ã‚¨ãƒªã® tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ä¿æŒ

**è¨­è¨ˆæ–¹é‡:**
- ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹åˆ¶å¾¡ï¼ˆã‚³ãƒ¼ãƒ‰å‰Šé™¤ã§ã¯ãªã„ï¼‰
- ä¸€è²«ã—ãŸå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ï¼ˆæœ¬æ›¸ï¼‰

---

#### NFR-4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**è¦ä»¶:**
- ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼ˆ404ã‚¨ãƒ©ãƒ¼ï¼‰
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç¶­æŒ
- API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ä¿æŒï¼ˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãªã—ï¼‰

**ç¢ºèªé …ç›®:**
- [ ] URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§404ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚‚404ã«ãªã‚‹
- [ ] APIå‘¼ã³å‡ºã—ã¯å¼•ãç¶šãå¯èƒ½ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿æŒã®ãŸã‚ï¼‰

---

## å®Ÿè£…è¨ˆç”»

### å‰ææ¡ä»¶ã¨åˆ¶ç´„äº‹é …

#### æŠ€è¡“çš„å‰ææ¡ä»¶

1. **Next.js App Router**: Server Component ã¨ Client Component ã®åŒºåˆ¥
2. **ãƒ“ãƒ«ãƒ‰æ™‚è©•ä¾¡**: `NEXT_PUBLIC_COMMUNITY_ID` ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«å›ºå®š
3. **ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã‚·ã‚¹ãƒ†ãƒ **: `enableFeatures` é…åˆ—ã«ã‚ˆã‚‹åˆ¶å¾¡
4. **GraphQL Apollo Client**: ã‚¯ã‚¨ãƒªã¨ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨
5. **React Hook Form**: æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†

#### åˆ¶ç´„äº‹é …

1. **ãƒ‡ãƒ¼ã‚¿ä¿æŒ**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã—ãªã„
2. **APIä¿æŒ**: GraphQL ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯å‰Šé™¤ã—ãªã„
3. **ã‚¯ã‚¨ãƒªä¿æŒ**: `GET_WALLETS_WITH_TICKET` ã® tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‰Šé™¤ã—ãªã„
4. **å†æœ‰åŠ¹åŒ–è€ƒæ…®**: ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã®åˆ‡ã‚Šæ›¿ãˆã®ã¿ã§å†æœ‰åŠ¹åŒ–å¯èƒ½ãªè¨­è¨ˆ

---

### å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

#### Phase 1: ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ç„¡åŠ¹åŒ– (å„ªå…ˆåº¦: ğŸ”´ æœ€é«˜)

**å®Ÿè£…æ™‚é–“è¦‹ç©ã‚‚ã‚Š:** 5åˆ†

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:**
1. `/src/lib/communities/metadata.ts`

**å®Ÿè£…å†…å®¹:**
```typescript
// Line 112ä»˜è¿‘ - neo88ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£
neo88: {
  id: "neo88",
  tokenName: "NEO88",
  title: "NEOå››å›½88ç¥­",
  // ...
  enableFeatures: [
    "opportunities",
    "points",
    "articles",
    // "tickets", // ğŸ”´ ã“ã®è¡Œã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    "prefectures",
    "quests"
  ],
  // ...
}

// Line 311-319ä»˜è¿‘ - defaultã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£
default: {
  id: "default",
  // ...
  enableFeatures: [
    "opportunities",
    "places",
    "points",
    "articles",
    // "tickets", // ğŸ”´ ã“ã®è¡Œã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    "prefectures",
    "quests"
  ],
  // ...
}
```

**æ¤œè¨¼æ–¹æ³•:**
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèª
npm run dev

# ç¢ºèªé …ç›®:
# 1. ç®¡ç†ç”»é¢ã‚’é–‹ã: http://localhost:3000/admin
#    â†’ ãƒœãƒˆãƒ ãƒãƒ¼ã«ãƒã‚±ãƒƒãƒˆã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨
# 2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã‚’é–‹ã
#    â†’ ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨
# 3. ç®¡ç†è¨­å®šãƒšãƒ¼ã‚¸ã‚’é–‹ã
#    â†’ ãƒã‚±ãƒƒãƒˆç®¡ç†ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨
```

**å½±éŸ¿ç¯„å›²:**
- âœ… AdminBottomBar.tsx - ãƒã‚±ãƒƒãƒˆã‚¿ãƒ–è‡ªå‹•éè¡¨ç¤º
- âœ… UserTicketsAndPoints.tsx - ãƒã‚±ãƒƒãƒˆè¡¨ç¤ºè‡ªå‹•éè¡¨ç¤º
- âœ… admin/page.tsx - è¨­å®šãƒªãƒ³ã‚¯è‡ªå‹•éè¡¨ç¤º
- âš ï¸ ãƒšãƒ¼ã‚¸æœ¬ä½“ - URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã¯å¯èƒ½ï¼ˆPhase 2ã§å¯¾å¿œï¼‰

---

#### Phase 2: ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ (å„ªå…ˆåº¦: ğŸŸ¡ é«˜)

**å®Ÿè£…æ™‚é–“è¦‹ç©ã‚‚ã‚Š:** 30åˆ†

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:**
1. `/src/app/tickets/page.tsx`
2. `/src/app/tickets/receive/page.tsx`
3. `/src/app/admin/tickets/page.tsx`
4. `/src/app/admin/tickets/[id]/page.tsx`
5. `/src/app/admin/tickets/utilities/page.tsx`

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰:**
```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function TicketsPage() {
  // ãƒšãƒ¼ã‚¸ã®å…ˆé ­ã§ãƒã‚§ãƒƒã‚¯
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound();
  }

  // æ—¢å­˜ã®å®Ÿè£…...
  return (
    <div>
      {/* æ—¢å­˜ã®JSX */}
    </div>
  );
}
```

**è©³ç´°ãªå®Ÿè£…æ‰‹é †:**

**1. `/src/app/tickets/page.tsx`**
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ 
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

// export default function ã®ç›´å¾Œã«è¿½åŠ 
export default function TicketsPage() {
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound();
  }

  // ä»¥ä¸‹ã€æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
  // ...
}
```

**2. `/src/app/tickets/receive/page.tsx`**
```typescript
// åŒæ§˜ã®å®Ÿè£…
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function TicketReceivePage() {
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound();
  }

  // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
  // ...
}
```

**3. `/src/app/admin/tickets/page.tsx`**
```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function AdminTicketsPage() {
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound();
  }

  // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
  // ...
}
```

**4. `/src/app/admin/tickets/[id]/page.tsx`**
```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function AdminTicketDetailPage({ params }: { params: { id: string } }) {
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound();
  }

  // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
  // ...
}
```

**5. `/src/app/admin/tickets/utilities/page.tsx`**
```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function AdminUtilitiesPage() {
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound();
  }

  // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
  // ...
}
```

**æ¤œè¨¼æ–¹æ³•:**
```bash
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª
# 1. /tickets ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ 404ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
# 2. /tickets/receive?token=test ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ 404ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
# 3. /admin/tickets ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ 404ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
# 4. /admin/tickets/123 ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ 404ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
# 5. /admin/tickets/utilities ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ 404ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
```

**å½±éŸ¿ç¯„å›²:**
- âœ… å…¨ãƒã‚±ãƒƒãƒˆé–¢é€£ãƒšãƒ¼ã‚¸ãŒ404ã‚¨ãƒ©ãƒ¼
- âœ… ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚„å¤ã„ãƒªãƒ³ã‚¯ã‚‚ç„¡åŠ¹åŒ–
- âœ… ä»–ã®ãƒšãƒ¼ã‚¸ã¸ã®å½±éŸ¿ãªã—

---

#### Phase 3: æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ç„¡åŠ¹åŒ– (å„ªå…ˆåº¦: ğŸŸ¢ ä¸­)

**å®Ÿè£…æ™‚é–“è¦‹ç©ã‚‚ã‚Š:** 20åˆ†

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:**
1. `/src/app/search/components/SearchFilters.tsx`

**å®Ÿè£…å†…å®¹:**

**Before (ç¾çŠ¶):**
```typescript
// Line 94-115
<FormField
  control={control}
  name="useTicket"
  render={() => (
    <FormItem>
      <FormControl>
        <FilterButton
          icon={<Tags className="h-4 w-4" />}
          label="ãã®ä»–ã®æ¡ä»¶"
          value=""
          active={useTicket}
          onClick={() => onFilterClick("other")}
          verticalLayout={true}
          className="rounded-b-xl"
        >
          {[useTicket && "ãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯", usePoints && "ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨å¯"]
            .filter(Boolean)
            .join(",")}
        </FilterButton>
      </FormControl>
    </FormItem>
  )}
/>
```

**After (ä¿®æ­£å¾Œ):**
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã« import è¿½åŠ 
import { currentCommunityConfig } from "@/lib/communities/metadata";

// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ feature flag ãƒã‚§ãƒƒã‚¯
const SearchFilters: React.FC<SearchFiltersProps> = ({
  onFilterClick,
  formatDateRange,
  prefectureLabels,
  location,
  dateRange,
  guests,
  useTicket,
  usePoints,
}) => {
  const { control } = useFormContext();

  // Feature flag ãƒã‚§ãƒƒã‚¯
  const isTicketsEnabled = currentCommunityConfig.enableFeatures.includes("tickets");

  return (
    <div className="bg-background rounded-xl overflow-hidden">
      {/* å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <FormField ... />

      {/* æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <FormField ... />

      {/* äººæ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <FormField ... />

      {/* ãã®ä»–ã®æ¡ä»¶ - æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */}
      {(isTicketsEnabled || usePoints) && (
        <FormField
          control={control}
          name="useTicket"
          render={() => (
            <FormItem>
              <FormControl>
                <FilterButton
                  icon={<Tags className="h-4 w-4" />}
                  label="ãã®ä»–ã®æ¡ä»¶"
                  value=""
                  active={useTicket}
                  onClick={() => onFilterClick("other")}
                  verticalLayout={true}
                  className="rounded-b-xl"
                >
                  {[
                    isTicketsEnabled && useTicket && "ãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯",
                    usePoints && "ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨å¯"
                  ]
                    .filter(Boolean)
                    .join(",")}
                </FilterButton>
              </FormControl>
            </FormItem>
          )}
        />
      )}
    </div>
  );
};
```

**æ¤œè¨¼æ–¹æ³•:**
```bash
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª
# 1. æ¤œç´¢ãƒšãƒ¼ã‚¸ã‚’é–‹ã: /search
#    â†’ ã€Œãã®ä»–ã®æ¡ä»¶ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„
#      ï¼ˆãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã¿ã®å ´åˆã¯è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
# 2. /search/result?ticket=1 ã«ã‚¢ã‚¯ã‚»ã‚¹
#    â†’ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIã«ã€Œãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯ã€ãŒè¡¨ç¤ºã•ã‚Œãªã„
# 3. ä»–ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå ´æ‰€ã€æ—¥ä»˜ã€äººæ•°ï¼‰ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨
```

**å½±éŸ¿ç¯„å›²:**
- âœ… ãƒã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒéè¡¨ç¤º
- âœ… ãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯å¼•ãç¶šãè¡¨ç¤º
- âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `ticket=1` ã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼ˆUIã«åæ˜ ã•ã‚Œãªã„ï¼‰
- âœ… GraphQL ã‚¯ã‚¨ãƒªã§ã¯ `isReservableWithTicket` ãŒè¨­å®šã•ã‚Œãªã„

---

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

å„Phaseã¯ç‹¬ç«‹ã—ã¦ãŠã‚Šã€å€‹åˆ¥ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½ï¼š

#### Phase 1ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```typescript
// /src/lib/communities/metadata.ts
// "tickets" ã‚’enableFeaturesã«æˆ»ã™
enableFeatures: [
  "opportunities",
  "points",
  "articles",
  "tickets", // â† å¾©å…ƒ
  "prefectures",
  "quests"
]
```

**æ‰€è¦æ™‚é–“:** 1åˆ†
**å½±éŸ¿:** ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºãŒå¾©å…ƒ

---

#### Phase 2ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```typescript
// å„ãƒšãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä»¥ä¸‹ã‚’å‰Šé™¤
// if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
//   notFound();
// }
```

**æ‰€è¦æ™‚é–“:** 10åˆ†
**å½±éŸ¿:** ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãŒå¾©å…ƒ

---

#### Phase 3ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```typescript
// SearchFilters.tsx ã‹ã‚‰æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å‰Šé™¤
// const isTicketsEnabled = ... ã‚’å‰Šé™¤
// {(isTicketsEnabled || usePoints) && ( ã‚’ {true && ( ã«å¤‰æ›´
```

**æ‰€è¦æ™‚é–“:** 5åˆ†
**å½±éŸ¿:** æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå¾©å…ƒ

---

### GraphQL ã‚¯ã‚¨ãƒªã®æ‰±ã„ï¼ˆé‡è¦ï¼‰

#### æ–¹é‡: ã‚¯ã‚¨ãƒªã¯å¤‰æ›´ã—ãªã„

**ç†ç”±:**
1. **å†æœ‰åŠ¹åŒ–ã®å®¹æ˜“æ€§**: ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã®åˆ‡ã‚Šæ›¿ãˆã®ã¿ã§å†æœ‰åŠ¹åŒ–å¯èƒ½
2. **ãƒ‡ãƒ¼ã‚¿ä¿æŒ**: APIå´ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã—ãªã„
3. **ã‚¨ãƒ©ãƒ¼å›é¿**: tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ã¨ã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿**: tickets ã¯é€šå¸¸0-10ä»¶ç¨‹åº¦ã§å½±éŸ¿è»½å¾®

**ç¾çŠ¶ç¶­æŒã™ã‚‹ã‚¯ã‚¨ãƒª:**
```typescript
// /src/graphql/account/wallet/query.ts
export const GET_WALLETS_WITH_TICKET = gql`
  query GetWalletsWithTicket($filter: WalletFilterInput, $first: Int, $cursor: String) {
    wallets(filter: $filter, first: $first, cursor: $cursor) {
      edges {
        node {
          ...WalletFields
          tickets {              # â† ã“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ®‹ã™
            ...TicketFields
            utility {
              ...UtilityFields
            }
          }
        }
      }
    }
  }
`;
```

**å½±éŸ¿:**
- ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ç„¡åŠ¹åŒ–å¾Œã‚‚ tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
- ãŸã ã—ã€UI ã§ã¯ä½¿ç”¨ã•ã‚Œãªã„ï¼ˆmaxTickets = 0 ã®ãŸã‚ï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿ã¯è»½å¾®

**ä»£æ›¿æ¡ˆï¼ˆæ¨å¥¨ã—ãªã„ï¼‰:**
- ã‚¯ã‚¨ãƒªã‚’2ã¤ä½œæˆï¼ˆWithTicket / WithoutTicketï¼‰ã—ã¦åˆ‡ã‚Šæ›¿ãˆ
  - âŒ è¤‡é›‘æ€§ãŒå¢—ã™
  - âŒ å†æœ‰åŠ¹åŒ–æ™‚ã®æ‰‹é–“ãŒå¢—ãˆã‚‹

---

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

#### TS-1: ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ç„¡åŠ¹åŒ–ã®ç¢ºèª

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æ“ä½œ | æœŸå¾…çµæœ | å„ªå…ˆåº¦ |
|-------------|------|---------|--------|
| TC-1.1 | ç®¡ç†ç”»é¢ã‚’é–‹ã | ãƒœãƒˆãƒ ãƒãƒ¼ã«ãƒã‚±ãƒƒãƒˆã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œãªã„ | P0 |
| TC-1.2 | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã‚’é–‹ã | ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œãªã„ | P0 |
| TC-1.3 | ç®¡ç†è¨­å®šãƒšãƒ¼ã‚¸ã‚’é–‹ã | ãƒã‚±ãƒƒãƒˆç®¡ç†ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œãªã„ | P1 |
| TC-1.4 | ãƒ“ãƒ«ãƒ‰å¾Œã«ç’°å¢ƒå¤‰æ•°ã‚’å¤‰æ›´ | å¤‰æ›´ãŒåæ˜ ã•ã‚Œãªã„ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚å›ºå®šã‚’ç¢ºèªï¼‰ | P2 |

#### TS-2: ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ç¢ºèª

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æ“ä½œ | æœŸå¾…çµæœ | å„ªå…ˆåº¦ |
|-------------|------|---------|--------|
| TC-2.1 | `/tickets` ã«ã‚¢ã‚¯ã‚»ã‚¹ | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | P0 |
| TC-2.2 | `/tickets/receive?token=xxx` ã«ã‚¢ã‚¯ã‚»ã‚¹ | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | P0 |
| TC-2.3 | `/admin/tickets` ã«ã‚¢ã‚¯ã‚»ã‚¹ | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | P0 |
| TC-2.4 | `/admin/tickets/123` ã«ã‚¢ã‚¯ã‚»ã‚¹ | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | P1 |
| TC-2.5 | `/admin/tickets/utilities` ã«ã‚¢ã‚¯ã‚»ã‚¹ | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | P1 |
| TC-2.6 | ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | P1 |
| TC-2.7 | å¤ã„QRã‚³ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ | 404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ | P1 |

#### TS-3: äºˆç´„æ©Ÿèƒ½ã®ç¢ºèª

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æ“ä½œ | æœŸå¾…çµæœ | å„ªå…ˆåº¦ |
|-------------|------|---------|--------|
| TC-3.1 | äºˆç´„ç¢ºèªç”»é¢ã‚’é–‹ã | ãƒã‚±ãƒƒãƒˆé¸æŠUIãŒè¡¨ç¤ºã•ã‚Œãªã„ | P0 |
| TC-3.2 | ãƒã‚¤ãƒ³ãƒˆã§äºˆç´„ã‚’ä½œæˆ | äºˆç´„ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ | P0 |
| TC-3.3 | ç¾é‡‘ã§äºˆç´„ã‚’ä½œæˆ | äºˆç´„ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ | P1 |
| TC-3.4 | GraphQL ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª | tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ | P2 |
| TC-3.5 | maxTickets ã®å€¤ã‚’ç¢ºèª | 0 ã«ãªã£ã¦ã„ã‚‹ | P1 |

#### TS-4: æ¤œç´¢æ©Ÿèƒ½ã®ç¢ºèª

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æ“ä½œ | æœŸå¾…çµæœ | å„ªå…ˆåº¦ |
|-------------|------|---------|--------|
| TC-4.1 | æ¤œç´¢ç”»é¢ã‚’é–‹ã | ã€Œãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„ | P0 |
| TC-4.2 | `?ticket=1` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§ã‚¢ã‚¯ã‚»ã‚¹ | ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIã«åæ˜ ã•ã‚Œãªã„ | P1 |
| TC-4.3 | ãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç¢ºèª | æ­£å¸¸ã«è¡¨ç¤ºãƒ»å‹•ä½œã™ã‚‹ | P0 |
| TC-4.4 | ä»–ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå ´æ‰€ã€æ—¥ä»˜ï¼‰ã‚’ç¢ºèª | æ­£å¸¸ã«è¡¨ç¤ºãƒ»å‹•ä½œã™ã‚‹ | P0 |

#### TS-5: ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æ“ä½œ | æœŸå¾…çµæœ | å„ªå…ˆåº¦ |
|-------------|------|---------|--------|
| TC-5.1 | ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ | æ­£å¸¸ã«å‹•ä½œã™ã‚‹ | P0 |
| TC-5.2 | ä½“é¨“äºˆç´„ã‚’ä½œæˆï¼ˆç¾é‡‘ï¼‰ | æ­£å¸¸ã«å‹•ä½œã™ã‚‹ | P0 |
| TC-5.3 | æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼ˆãƒã‚±ãƒƒãƒˆä»¥å¤–ï¼‰ | æ­£å¸¸ã«å‹•ä½œã™ã‚‹ | P0 |
| TC-5.4 | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º | ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ | P1 |
| TC-5.5 | ç®¡ç†ç”»é¢ã®ä»–æ©Ÿèƒ½ | æ­£å¸¸ã«å‹•ä½œã™ã‚‹ | P1 |

### ãƒ†ã‚¹ãƒˆç’°å¢ƒ

- **é–‹ç™ºç’°å¢ƒ:** ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ï¼ˆ`npm run dev`ï¼‰
- **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ:** ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒï¼ˆæœ¬ç•ªå‰æ¤œè¨¼ï¼‰
- **æœ¬ç•ªç’°å¢ƒ:** æœ¬ç•ªç’°å¢ƒï¼ˆãƒªãƒªãƒ¼ã‚¹å¾Œç›£è¦–ï¼‰

### ãƒ†ã‚¹ãƒˆå®Ÿæ–½ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```mermaid
gantt
    title ãƒ†ã‚¹ãƒˆå®Ÿæ–½ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    dateFormat  YYYY-MM-DD
    section Phase 1
    å®Ÿè£…           :p1-impl, 2025-12-05, 5m
    TS-1å®Ÿæ–½       :p1-test, after p1-impl, 15m
    section Phase 2
    å®Ÿè£…           :p2-impl, after p1-test, 30m
    TS-1,TS-2å®Ÿæ–½  :p2-test, after p2-impl, 30m
    section Phase 3
    å®Ÿè£…           :p3-impl, after p2-test, 20m
    å…¨ãƒ†ã‚¹ãƒˆå®Ÿæ–½   :p3-test, after p3-impl, 1h
    section ãƒªãƒªãƒ¼ã‚¹
    æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹    :release, after p3-test, 10m
    TS-5å®Ÿæ–½       :regression, after release, 30m
```

1. **Phase 1å®Œäº†å¾Œ:** TS-1ã‚’å®Ÿæ–½ï¼ˆ15åˆ†ï¼‰
2. **Phase 2å®Œäº†å¾Œ:** TS-1, TS-2ã‚’å®Ÿæ–½ï¼ˆ30åˆ†ï¼‰
3. **Phase 3å®Œäº†å¾Œ:** å…¨ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’å®Ÿæ–½ï¼ˆ1æ™‚é–“ï¼‰
4. **æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å¾Œ:** TS-5ï¼ˆãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ï¼‰ã‚’å®Ÿæ–½ï¼ˆ30åˆ†ï¼‰

---

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

### ãƒªã‚¹ã‚¯ç®¡ç†è¡¨

| ãƒªã‚¹ã‚¯ID | ãƒªã‚¹ã‚¯å†…å®¹ | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | å¯¾ç­– | æ‹…å½“ |
|---------|----------|--------|---------|------|------|
| R-1 | URLã‚’ç›´æ¥çŸ¥ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ï¼ˆPhase 1ã®ã¿å®Ÿæ–½æ™‚ï¼‰ | ä¸­ | é«˜ | Phase 2ã‚’å®Ÿæ–½ã—ã¦ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ | é–‹ç™º |
| R-2 | æ—¢å­˜ã®ãƒã‚±ãƒƒãƒˆã‚’ä¿æœ‰ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å•ã„åˆã‚ã› | ä¸­ | ä¸­ | ã‚µãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«æ¡ˆå†…ã‚’è¿½åŠ ã€ãƒã‚±ãƒƒãƒˆæœ‰åŠ¹æœŸé™ã®å‘ŠçŸ¥ | CS |
| R-3 | ä»–æ©Ÿèƒ½ã¸ã®å½±éŸ¿ï¼ˆäºˆç´„ã€ãƒã‚¤ãƒ³ãƒˆç­‰ï¼‰ | é«˜ | ä½ | ååˆ†ãªãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ | QA |
| R-4 | ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…æ¼ã‚Œ | ä¸­ | ä½ | ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å…¨ç®‡æ‰€ã‚’ç¢ºèª | é–‹ç™º |
| R-5 | å°†æ¥ã®å†æœ‰åŠ¹åŒ–ãŒå›°é›£ | ä½ | ä½ | ãƒ‡ãƒ¼ã‚¿ã¨APIã‚’ä¿æŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ | é–‹ç™º |
| R-6 | GraphQL ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿ | ä½ | ä½ | tickets ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯è»½å¾®ï¼ˆ0-10ä»¶ç¨‹åº¦ï¼‰ | é–‹ç™º |
| R-7 | ãƒ“ãƒ«ãƒ‰æ™‚ã®ç’°å¢ƒå¤‰æ•°è¨­å®šãƒŸã‚¹ | é«˜ | ä½ | ãƒ“ãƒ«ãƒ‰å‰ã«ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã€CIã§ãƒã‚§ãƒƒã‚¯ | DevOps |

### å¯¾å¿œå„ªå…ˆåº¦

- **é«˜:** R-3ï¼ˆä»–æ©Ÿèƒ½ã¸ã®å½±éŸ¿ï¼‰ã€R-7ï¼ˆç’°å¢ƒå¤‰æ•°è¨­å®šãƒŸã‚¹ï¼‰
- **ä¸­:** R-1ï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼‰ã€R-2ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å•ã„åˆã‚ã›ï¼‰ã€R-4ï¼ˆå®Ÿè£…æ¼ã‚Œï¼‰
- **ä½:** R-5ï¼ˆå†æœ‰åŠ¹åŒ–ï¼‰ã€R-6ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰

### ãƒªã‚¹ã‚¯è©³ç´°ã¨å¯¾ç­–

#### R-1: Phase 1ã®ã¿å®Ÿæ–½æ™‚ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹

**ãƒªã‚¹ã‚¯:**
- ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‚‚ã€URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**å¯¾ç­–:**
- Phase 2ã‚’å¿…ãšå®Ÿæ–½ã™ã‚‹
- Phase 1ã¨ Phase 2 ã‚’åŒæ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

**æ¤œè¨¼:**
- [ ] Phase 1å®Ÿè£…å¾Œã€`/tickets` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] Phase 2å®Ÿè£…å¾Œã€404ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

#### R-2: æ—¢å­˜ãƒã‚±ãƒƒãƒˆä¿æœ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å•ã„åˆã‚ã›

**ãƒªã‚¹ã‚¯:**
- ãƒã‚±ãƒƒãƒˆã‚’ä¿æœ‰ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œãƒã‚±ãƒƒãƒˆãŒä½¿ãˆãªã„ã€ã¨ã„ã†å•ã„åˆã‚ã›

**å¯¾ç­–:**
- äº‹å‰å‘ŠçŸ¥: ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½åœæ­¢ã®1é€±é–“å‰ã«å‘ŠçŸ¥
- ã‚µãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«æ¡ˆå†…ã‚’è¿½åŠ 
- æ—¢å­˜ãƒã‚±ãƒƒãƒˆã®æœ‰åŠ¹æœŸé™ã‚’æ˜ç¤º

**å¯¾å¿œãƒ•ãƒ­ãƒ¼:**
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒã‚±ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„
  â†“
CS: ãƒã‚±ãƒƒãƒˆæ©Ÿèƒ½ã¯åœæ­¢ã—ã¾ã—ãŸ
  â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ä¿æœ‰ãƒã‚±ãƒƒãƒˆã¯ã©ã†ãªã‚‹ï¼Ÿ
  â†“
CS: ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¦ã„ã¾ã™ã€‚å†æœ‰åŠ¹åŒ–æ™‚ã«ä½¿ç”¨å¯èƒ½ã§ã™
```

---

#### R-3: ä»–æ©Ÿèƒ½ã¸ã®å½±éŸ¿

**ãƒªã‚¹ã‚¯:**
- ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã€äºˆç´„æ©Ÿèƒ½ã«äºˆæœŸã—ãªã„å½±éŸ¿

**å¯¾ç­–:**
- ååˆ†ãªãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§äº‹å‰æ¤œè¨¼
- æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å¾Œã®ç›£è¦–

**æ¤œè¨¼é …ç›®:**
- [ ] ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨ã§ã®äºˆç´„ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹
- [ ] ç¾é‡‘ã§ã®äºˆç´„ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹
- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã§ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æ¤œç´¢æ©Ÿèƒ½ï¼ˆãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‰ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

## ä»˜éŒ²

### A. å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

#### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (Phase 1)
- `/src/lib/communities/metadata.ts` - Line 112ä»˜è¿‘, Line 311-319ä»˜è¿‘

#### ãƒšãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ« (Phase 2)
- `/src/app/tickets/page.tsx` - ãƒã‚±ãƒƒãƒˆä¸€è¦§
- `/src/app/tickets/receive/page.tsx` - ãƒã‚±ãƒƒãƒˆå—ã‘å–ã‚Š
- `/src/app/admin/tickets/page.tsx` - ç®¡ç†ç”»é¢ãƒã‚±ãƒƒãƒˆä¸€è¦§
- `/src/app/admin/tickets/[id]/page.tsx` - ãƒã‚±ãƒƒãƒˆè©³ç´°
- `/src/app/admin/tickets/utilities/page.tsx` - Utilityç®¡ç†

#### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ« (Phase 3)
- `/src/app/search/components/SearchFilters.tsx` - Line 94-115

#### è‡ªå‹•çš„ã«å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¤‰æ›´ä¸è¦ï¼‰
- `/src/components/layout/AdminBottomBar.tsx` - Line 53-60
- `/src/app/users/features/profile/components/UserTicketsAndPoints.tsx` - Line 61-65
- `/src/app/admin/page.tsx` - Line 37-42, 76-80
- `/src/app/reservation/confirm/components/payment/PaymentSection.tsx` - Line 101-114 (maxTickets=0ã§è‡ªå‹•éè¡¨ç¤º)

#### å½±éŸ¿ã‚’å—ã‘ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç¢ºèªã®ã¿ï¼‰
- `/src/graphql/account/wallet/query.ts` - GraphQLã‚¯ã‚¨ãƒªï¼ˆå¤‰æ›´ã—ãªã„ï¼‰
- `/src/app/reservation/confirm/hooks/useWalletData.ts` - ticketså–å¾—ï¼ˆå¤‰æ›´ã—ãªã„ï¼‰

---

### B. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³é›†

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: Server Component ã§ã®ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**ç”¨é€”:** ãƒã‚±ãƒƒãƒˆé–¢é€£ãƒšãƒ¼ã‚¸ã§404ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

```typescript
import { currentCommunityConfig } from "@/lib/communities/metadata";
import { notFound } from "next/navigation";

export default function TicketsPage() {
  // ãƒšãƒ¼ã‚¸ã®å…ˆé ­ã§ãƒã‚§ãƒƒã‚¯
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    notFound(); // 404ã‚¨ãƒ©ãƒ¼
  }

  // æ—¢å­˜ã®å®Ÿè£…
  return <div>ãƒã‚±ãƒƒãƒˆä¸€è¦§</div>;
}
```

**é©ç”¨ç®‡æ‰€:**
- `/src/app/tickets/page.tsx`
- `/src/app/tickets/receive/page.tsx`
- `/src/app/admin/tickets/page.tsx`
- `/src/app/admin/tickets/[id]/page.tsx`
- `/src/app/admin/tickets/utilities/page.tsx`

---

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: Client Component ã§ã®æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

**ç”¨é€”:** æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã©ã®UIè¦ç´ ã‚’éè¡¨ç¤º

```typescript
"use client";
import { currentCommunityConfig } from "@/lib/communities/metadata";

export function SearchFilters() {
  const isTicketsEnabled = currentCommunityConfig.enableFeatures.includes("tickets");

  return (
    <div>
      {/* ä»–ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}

      {/* ãƒã‚±ãƒƒãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ - æ¡ä»¶ä»˜ãè¡¨ç¤º */}
      {isTicketsEnabled && (
        <FilterButton label="ãƒã‚±ãƒƒãƒˆåˆ©ç”¨å¯" />
      )}
    </div>
  );
}
```

**é©ç”¨ç®‡æ‰€:**
- `/src/app/search/components/SearchFilters.tsx`

---

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ï¼ˆnullã‚’è¿”ã™ï¼‰

**ç”¨é€”:** ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå…¨ä½“ã‚’éè¡¨ç¤º

```typescript
"use client";
import { currentCommunityConfig } from "@/lib/communities/metadata";

export function TicketWidget() {
  // æ©Ÿèƒ½ãŒç„¡åŠ¹ãªå ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
  if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
    return null;
  }

  return <div>ãƒã‚±ãƒƒãƒˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ</div>;
}
```

**é©ç”¨ç®‡æ‰€:**
- ã‚«ã‚¹ã‚¿ãƒ ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- ä»Šå›ã®å®Ÿè£…ã§ã¯ä½¿ç”¨ã—ãªã„ï¼ˆæ—¢å­˜ã®æ¡ä»¶åˆ†å²ã§å¯¾å¿œæ¸ˆã¿ï¼‰

---

#### ãƒ‘ã‚¿ãƒ¼ãƒ³4: æ—¢å­˜ã®æ¡ä»¶åˆ†å²ã‚’æ´»ç”¨

**ç”¨é€”:** æ—¢ã«æ¡ä»¶åˆ†å²ãŒå­˜åœ¨ã™ã‚‹å ´åˆ

```typescript
// /src/components/layout/AdminBottomBar.tsx (Line 53-60)
// ã™ã§ã«ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹
{enabledFeatures.includes("tickets") && (
  <Link href="/admin/tickets">
    <Ticket size={24} />
    <span>{t("navigation.adminBottomBar.tickets")}</span>
  </Link>
)}

// âœ… ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤‰æ›´ä¸è¦ï¼ˆæ—¢å­˜ã®å®Ÿè£…ã§å¯¾å¿œæ¸ˆã¿ï¼‰
```

**é©ç”¨ç®‡æ‰€:**
- `AdminBottomBar.tsx`
- `UserTicketsAndPoints.tsx`
- `admin/page.tsx`
- `PaymentSection.tsx` (maxTickets=0 ã§è‡ªå‹•éè¡¨ç¤º)

---

### C. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### Q1: Phase 1 å®Ÿè£…å¾Œã‚‚ãƒã‚±ãƒƒãƒˆã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› :**
- ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ®‹ã£ã¦ã„ã‚‹
- `.next` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå¤ã„

**å¯¾å‡¦:**
```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
# .next ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
rm -rf .next

# å†ãƒ“ãƒ«ãƒ‰
npm run dev
```

---

#### Q2: 404ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãã€ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› :**
- Phase 2 ã®å®Ÿè£…ãŒæ¼ã‚Œã¦ã„ã‚‹
- `notFound()` ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæ¼ã‚Œã¦ã„ã‚‹

**ç¢ºèª:**
```typescript
// 1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ç¢ºèª
import { notFound } from "next/navigation"; // â† ã“ã‚ŒãŒã‚ã‚‹ã‹ï¼Ÿ

// 2. notFound() ã®å‘¼ã³å‡ºã—ã‚’ç¢ºèª
if (!currentCommunityConfig.enableFeatures.includes("tickets")) {
  notFound(); // â† ã“ã‚ŒãŒã‚ã‚‹ã‹ï¼Ÿ
}
```

---

#### Q3: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
Error: currentCommunityConfig is not defined
```

**åŸå› :**
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæ¼ã‚Œã¦ã„ã‚‹

**å¯¾å‡¦:**
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ 
import { currentCommunityConfig } from "@/lib/communities/metadata";
```

---

#### Q4: æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå®Œå…¨ã«æ¶ˆãˆã¦ã—ã¾ã†

**åŸå› :**
- ãƒã‚¤ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚å«ã‚ã¦éè¡¨ç¤ºã«ã—ã¦ã—ã¾ã£ãŸ

**æ­£ã—ã„å®Ÿè£…:**
```typescript
// âŒ é–“é•ã„
{isTicketsEnabled && (
  <FormField ... />  // â† ãƒã‚¤ãƒ³ãƒˆã‚‚å«ã‚ã¦éè¡¨ç¤º
)}

// âœ… æ­£ã—ã„
{(isTicketsEnabled || usePoints) && (
  <FormField ... />  // â† ã©ã¡ã‚‰ã‹ãŒã‚ã‚Œã°è¡¨ç¤º
)}
```

---

### D. ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£åˆ¥ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ä¸€è¦§

| ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ID | tickets | å‚™è€ƒ |
|--------------|---------|------|
| neo88 | âœ… â†’ âŒ | ä»Šå›ç„¡åŠ¹åŒ– |
| default | âœ… â†’ âŒ | ä»Šå›ç„¡åŠ¹åŒ– |
| himeji-ymca | âŒ | ã™ã§ã«ç„¡åŠ¹ |
| kibotcha | âŒ | ã™ã§ã«ç„¡åŠ¹ |
| dais | âŒ | ã™ã§ã«ç„¡åŠ¹ |
| kotohira | âŒ | ã™ã§ã«ç„¡åŠ¹ |
| izu | âŒ | ã™ã§ã«ç„¡åŠ¹ |

---

### E. å‚è€ƒãƒªãƒ³ã‚¯

**å†…éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:**
- GraphQLã‚¹ã‚­ãƒ¼ãƒ: `/src/graphql/reward/`
- ãƒã‚±ãƒƒãƒˆé–¢é€£å‹å®šç¾©: `/src/app/tickets/data/type.ts`
- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨­å®š: `/src/lib/communities/metadata.ts`
- äºˆç´„ã‚·ã‚¹ãƒ†ãƒ : `/src/app/reservation/confirm/`

**å¤–éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:**
- Next.js App Router: https://nextjs.org/docs/app
- Next.js notFound: https://nextjs.org/docs/app/api-reference/functions/not-found
- Apollo Client: https://www.apollographql.com/docs/react/

---

### F. å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|----------|------|---------|--------|
| 1.0 | 2025-12-05 | åˆç‰ˆä½œæˆ | Claude |
| 1.1 | 2025-12-05 | å°‚é–€çš„ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã‚’åæ˜ <br/>- ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®å‰ææ¡ä»¶ã‚’è¿½åŠ <br/>- èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼ã‚’è¿½åŠ <br/>- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’è¿½åŠ <br/>- GraphQLã‚¯ã‚¨ãƒªã®æ‰±ã„ã‚’æ˜ç¢ºåŒ–<br/>- å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³é›†ã‚’æ‹¡å…… | Claude |

---

## æ‰¿èª

| å½¹å‰² | æ°å | æ‰¿èªæ—¥ | ç½²å |
|-----|------|--------|------|
| ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ | | | |
| æŠ€è¡“ãƒªãƒ¼ãƒ‰ | | | |
| QAãƒªãƒ¼ãƒ‰ | | | |

---

**END OF DOCUMENT**

---

## ğŸ“Œ ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

æœ¬è¦ä»¶å®šç¾©æ›¸ã¯ã€ä»¥ä¸‹ã®ç‚¹ã‚’é‡è¦–ã—ã¦ä½œæˆã—ã¾ã—ãŸï¼š

1. **æŠ€è¡“çš„å‰ææ¡ä»¶ã®æ˜ç¢ºåŒ–**: Next.js App Routerã€ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã‚·ã‚¹ãƒ†ãƒ ã€GraphQLã®ä»•çµ„ã¿ã‚’ä¸å¯§ã«èª¬æ˜
2. **èª¿æŸ»çµæœã®åæ˜ **: ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹èª¿æŸ»ã§åˆ¤æ˜ã—ãŸäº‹å®Ÿã‚’ã™ã¹ã¦åæ˜ 
3. **å®Ÿè£…ã®å…·ä½“æ€§**: å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ç®‡æ‰€ã‚’è¡Œç•ªå·ã¾ã§æ˜è¨˜
4. **ãƒªã‚¹ã‚¯ã®å¯è¦–åŒ–**: èµ·ã“ã‚Šã†ã‚‹å•é¡Œã¨ãã®å¯¾ç­–ã‚’äº‹å‰ã«æ•´ç†
5. **ä¿å®ˆæ€§ã®ç¢ºä¿**: å†æœ‰åŠ¹åŒ–ã‚’å®¹æ˜“ã«ã™ã‚‹è¨­è¨ˆ

ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
